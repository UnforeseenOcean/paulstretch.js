<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8"> 
  <script src="js/AudioContextMonkeyPatch.js"></script>
  <script src="js/paulstretch.js"></script>
  <style>
    button, input {
      font-family: sans-serif;
      border: none;
      background-color: #333;
      color: #ddd;
      padding: 0.4em 0.6em;
      border-radius: 0.2em;
    }
    input[type="submit"] {
      background-color: #444;
      cursor: pointer;
    }
    input[type="submit"]:hover {
      background-color: #666;
    }
    body {
      color: #ddd;
      background-color: #111;
      font-family: sans-serif;
    }


  </style>
</head>

<body>
  <audio id="audioSource" src="sounds/miles.wav"></audio>
  <form id="config">
    <input name="ratio" type="text" />
    <input type="submit" value="change stretch ratio" />
  </form>
  <p>
    <a href="https://github.com/sebpiq/paulstretch.js">paulstretch.js</a> simple example. By <a href="http://funktion.fm">SÃ©bastien Piquemal</a>
  </p>
  <script>
    var context = new AudioContext
      , bufferSize = 4096
      , batchSize = 4
      , winSize = 4096 * 4
      , paulstretchWorker = new Worker('js/paulstretch-worker.js')
      , paulstretchNode = context.createScriptProcessor(bufferSize, 1, 1)
      , audioSource = document.getElementById('audioSource')
      , sourceNode = context.createMediaElementSource(audioSource)
      , blocksIn = [], blocksOut = []

    paulstretchWorker.postMessage({
      type: 'init',
      winSize: winSize,
      numberOfChannels: 1,
      blockSize: bufferSize,
      batchSize: batchSize,
    })

    var configForm = document.getElementById('config')
    configForm.onsubmit = function() {
      var ratio = parseFloat(this.elements[0].value)
      paulstretchWorker.postMessage({ type: 'config', ratio: ratio })
      return false
    }

    audioSource.addEventListener('canplay', function() {

      audioSource.play()

      paulstretchWorker.onmessage = function (event) {
        // Add all the blocks from the batch to the `blocksOut` queue.
        if (event.data.type === 'read') {
          var blocks = event.data.data
          while (blocks.length) blocksOut.push(blocks.shift())
        }
      }
    
      paulstretchNode.onaudioprocess = function(event) {
        // Add every incoming block to the `blocksIn` queue
        blocksIn.push([event.inputBuffer.getChannelData(0)])
        // If there is any processed block, read it ...
        if (blocksOut.length)
          event.outputBuffer.getChannelData(0).set(blocksOut.shift()[0])
      }

      // Periodically, handle the `blockIn` and `blockOut` queues :
      // Send `blocksIn` to the worker for future processing and ask for batches that are ready to put in `blocksOut`.
      setInterval(function() {
        if (blocksIn.length)
          paulstretchWorker.postMessage({ type: 'write', data: blocksIn.shift() })

        if (blocksOut.length < batchSize) 
          paulstretchWorker.postMessage({ type: 'read' })
      }, 100)

      sourceNode.connect(paulstretchNode)
      paulstretchNode.connect(context.destination)

    }, true)



  </script>
</body>

</html>